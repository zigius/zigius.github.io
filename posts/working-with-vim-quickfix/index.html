<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>Search and replace in vim | zlog - the zigius blog</title>
<meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Why use the quickfix list? Recently I started using the quickfix list in vim, a hidden gem in the vim ecosystem. The main reason I started working with the qf list is I wanted a way to search and replace text in multiple files in my project.
getting started - search I use telescope and FZF as my search plugins, but they do not provide replace functionality out of the box."><meta name=generator content="Hugo 0.121.1"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Search and replace in vim"><meta property="og:description" content="Why use the quickfix list? Recently I started using the quickfix list in vim, a hidden gem in the vim ecosystem. The main reason I started working with the qf list is I wanted a way to search and replace text in multiple files in my project.
getting started - search I use telescope and FZF as my search plugins, but they do not provide replace functionality out of the box."><meta property="og:type" content="article"><meta property="og:url" content="https://zigius.github.io/posts/working-with-vim-quickfix/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-18T15:35:17+02:00"><meta property="article:modified_time" content="2023-02-18T15:35:17+02:00"><meta itemprop=name content="Search and replace in vim"><meta itemprop=description content="Why use the quickfix list? Recently I started using the quickfix list in vim, a hidden gem in the vim ecosystem. The main reason I started working with the qf list is I wanted a way to search and replace text in multiple files in my project.
getting started - search I use telescope and FZF as my search plugins, but they do not provide replace functionality out of the box."><meta itemprop=datePublished content="2023-02-18T15:35:17+02:00"><meta itemprop=dateModified content="2023-02-18T15:35:17+02:00"><meta itemprop=wordCount content="874"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Search and replace in vim"><meta name=twitter:description content="Why use the quickfix list? Recently I started using the quickfix list in vim, a hidden gem in the vim ecosystem. The main reason I started working with the qf list is I wanted a way to search and replace text in multiple files in my project.
getting started - search I use telescope and FZF as my search plugins, but they do not provide replace functionality out of the box."></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">zlog - the zigius blog</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">Search and replace in vim</h1><time class="f6 mv4 dib tracked" datetime=2023-02-18T15:35:17+02:00>February 18, 2023</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><h2 id=why-use-the-quickfix-list>Why use the quickfix list?</h2><p>Recently I started using the quickfix list in vim, a hidden gem in the vim
ecosystem. The main reason I started working with the qf list is I wanted a way
to search and replace text in multiple files in my project.</p><h2 id=getting-started---search>getting started - search</h2><p>I use telescope and FZF as my search plugins, but they do not provide
replace functionality out of the box. They do however, support sending all or a
selected search results to the quickfix list. To send all results of <code>telescope grep_string</code>
picker to quickfix, you can use the C-Q keyboard shortcut.
To send selected results to quickfix list, select the items you want using TAB, and press ALT-Q to send the selection to the quickfix.
In FZF, you can select entries in the same way, using the TAB key, and send them
to the quickfix list with CTRL+T.</p><h2 id=getting-started---replace>getting started - replace</h2><p>Now that we have the results populated in the qf list, we need a way to replace
the text. We will use the cdo command.
To replace text in items from quickfix, use the following command:</p><pre tabindex=0><code>:cdo s/foo/bar
</code></pre><p><code>cdo</code> runs the command on all items in the quickfix list. For a more in depth
guide you can view the following <a href=https://chrisarcand.com/vims-new-cdo-command/>blog post</a></p><h2 id=search-and-replace---advanced-configurations>search and replace - advanced configurations.</h2><p>I wanted a way to remove items from the qf list. I found a <a href=https://github.com/romainl/vim-qf>plugin</a>
that does exactly what I need. The <code>vim-qf</code> plugin enhances the qf list with
additional features and mappings. One of the cool features of the plugin
is the <code>Reject</code> command. You can remove the current result from the qf list
by running the following command:
<code>:.Reject</code></p><p>Using the Reject command, I can optimize the results of the search query
without having to search using a fuzzy finder again.</p><p>I created a ftplugin for the quickfix list, and mapped <code>dd</code> to reject files
from the list.
filename: <code>/Users/myusername/.vim/after/ftplugin/qf.lua</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>vim.keymap.set(<span style=color:#e6db74>&#39;n&#39;</span>, <span style=color:#e6db74>&#39;dd&#39;</span>, <span style=color:#e6db74>&#39;:.Reject&lt;CR&gt;&#39;</span>, {buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>})
</span></span></code></pre></div><p>Now, when in the qf list, I can press dd and it will remove the file from the
list.</p><h2 id=advanced-configuration-2---search-in-qf-files>Advanced configuration 2 - search in qf files.</h2><p>Another great usage that I found for the quickfix list - searching for multiple
text strings in files. Lets say that I am searching for a file that contains the
words <code>foo</code> and <code>bar</code>, but the words are not in the same line. Telescope and fzf
will not be able to provide me with files containing both of the strings.
Lets view an example text:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>foo
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>foobar
</span></span></code></pre></div><p>And lets see the results given to us by searching for foo and bar using fzf:
<img src="https://drive.google.com/uc?id=13905HLn-_hW47cyyHYt1Xc5Ce8LkWibF" alt="Search foo bar"></p><p>So how can we search for files containing foo and bar?
Use the qf list ðŸ˜Ž
First, we will populate the qf list with the results of searching for foo as
described above.
Now that we have all the files containing the string foo in the qf list, how can
we search those files for the string bar?</p><p>We can use a custom telescope function I created to search the files in the qf list:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-lua data-lang=lua><span style=display:flex><span>require(<span style=color:#e6db74>&#39;telescope&#39;</span>).setup {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- search in quickfix list items</span>
</span></span><span style=display:flex><span>vim.keymap.set(<span style=color:#e6db74>&#39;n&#39;</span>, <span style=color:#e6db74>&#39;&lt;leader&gt;mq&#39;</span>, <span style=color:#66d9ef>function</span>()
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> set <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> items <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> _, item <span style=color:#66d9ef>in</span> ipairs(vim.fn.getqflist()) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> set[item.bufnr] <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>      set[item.bufnr] <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      table.insert(items, { file_name <span style=color:#f92672>=</span> vim.api.nvim_buf_get_name(item.bufnr) })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>local</span> list <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> i, item <span style=color:#66d9ef>in</span> ipairs(items) <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>    list[i] <span style=color:#f92672>=</span> item.file_name
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>-- vim.pretty_print(list)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  builtin.grep_string({
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- cwd = &#39;~&#39;,</span>
</span></span><span style=display:flex><span>    search <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>,
</span></span><span style=display:flex><span>    search_dirs <span style=color:#f92672>=</span> list,
</span></span><span style=display:flex><span>  })
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>, opts)
</span></span></code></pre></div><p>This Lua function sets a key mapping for the normal mode in Vim. The key mapping is mq,
which means the leader key (usually the backslash \ key) followed by the letter &ldquo;m&rdquo; and then the letter &ldquo;q&rdquo;.</p><p>When this key mapping is triggered, it executes an anonymous function that does the following:</p><p>Initializes two empty tables, set and items.
Uses the built-in getqflist function in Vim to get a list of quickfix items. Each quickfix
item represents a location in a file where the string foo was found.
Iterates over the list of quickfix items and creates a new table <code>items</code> that contains only the file names of the items, without duplicates.
Creates a new table list that contains only the file names of the items, in the order they were encountered in items.
Calls the telescope <code>grep_string</code> function with a table that contains the following arguments:
search: an empty string, indicating that we want to search for nothing.
search_dirs: a list of file names that we want to search in. This list is the list table we just created.
By passing it a list of qf file names, we are telling it to search for the empty string in all of those files.</p><p>Place the function in your telescope.nvim configuration file, or anywhere else
you would like. To read more about lua in neovim, check out my previous blog
post on <a href=https://zigius.github.io/posts/create-neovim-plugin/>creating a neovim plugin</a></p><p>Now we can search those files for the string <code>bar</code></p><h2 id=advanced-configuration-2---more-plugins-and-tricks>Advanced configuration 2 - more plugins and tricks.</h2><ol><li>To open the qf list you need to use this command: <code>:copen</code>.</li><li>I also use <a href=https://github.com/kevinhwang91/nvim-bqf>this plugin</a> to have a preview of the results in the qf list.</li></ol><p>Thats it for today ðŸ˜Š</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://zigius.github.io/>&copy; zlog - the zigius blog 2024</a><div><div class=ananke-socials></div></div></div></footer></body></html>