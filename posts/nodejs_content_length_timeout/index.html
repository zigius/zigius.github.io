<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>The story of the content-length header | zlog - the zigius blog</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="As part of my job, Me and my team are responsible for the data pipeline of our division. Our collection layer of all the analytics events is written in typescript with an express server. It is responsible for handling and processing more than 3M requests every minute.
As part of a rewrite of the collection layer, we noticed that we have requests that take more than a minute to progress. Our p99 response time is a lot better: So why do we have requests that take more than a minute to process?"><meta name=generator content="Hugo 0.108.0"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="The story of the content-length header"><meta property="og:description" content="As part of my job, Me and my team are responsible for the data pipeline of our division. Our collection layer of all the analytics events is written in typescript with an express server. It is responsible for handling and processing more than 3M requests every minute.
As part of a rewrite of the collection layer, we noticed that we have requests that take more than a minute to progress. Our p99 response time is a lot better: So why do we have requests that take more than a minute to process?"><meta property="og:type" content="article"><meta property="og:url" content="https://zigius.github.io/posts/nodejs_content_length_timeout/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-06T15:59:12+02:00"><meta property="article:modified_time" content="2022-12-06T15:59:12+02:00"><meta itemprop=name content="The story of the content-length header"><meta itemprop=description content="As part of my job, Me and my team are responsible for the data pipeline of our division. Our collection layer of all the analytics events is written in typescript with an express server. It is responsible for handling and processing more than 3M requests every minute.
As part of a rewrite of the collection layer, we noticed that we have requests that take more than a minute to progress. Our p99 response time is a lot better: So why do we have requests that take more than a minute to process?"><meta itemprop=datePublished content="2022-12-06T15:59:12+02:00"><meta itemprop=dateModified content="2022-12-06T15:59:12+02:00"><meta itemprop=wordCount content="651"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="The story of the content-length header"><meta name=twitter:description content="As part of my job, Me and my team are responsible for the data pipeline of our division. Our collection layer of all the analytics events is written in typescript with an express server. It is responsible for handling and processing more than 3M requests every minute.
As part of a rewrite of the collection layer, we noticed that we have requests that take more than a minute to progress. Our p99 response time is a lot better: So why do we have requests that take more than a minute to process?"></head><body class="ma0 avenir bg-near-white"><header><div class=bg-black><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">zlog - the zigius blog</a><div class="flex-l items-center"><div class=ananke-socials></div></div></div></nav></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"></div><h1 class="f1 athelas mt3 mb1">The story of the content-length header</h1><time class="f6 mv4 dib tracked" datetime=2022-12-06T15:59:12+02:00>December 6, 2022</time></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>As part of my job, Me and my team are responsible for the data pipeline of our division.
Our collection layer of all the analytics events is written in typescript with an express server. It is responsible for handling
and processing more than 3M requests every minute.</p><p>As part of a rewrite of the collection layer, we noticed that we have requests that take more than a minute to progress.
<img src="https://drive.google.com/uc?id=10FLQfEn645vsVBXOfvpZFlvfF5dvqjpm" alt="Max response time"></p><p>Our p99 response time is a lot better:
<img src="https://drive.google.com/uc?id=10GTx_K7hrtphNbJYV6bB-A9tqYbPEK3k" alt="p99 response time"></p><p>So why do we have requests that take more than a minute to process?
As part of the research of the max response time we found two issues in our code.</p><h2 id=alb-idle-time>ALB idle time</h2><p>We expose the API behind an aws ALB with an idle timeout of 16 seconds. Why do we see requests that take more than 16 seconds?
This issue still has no definitive solution, and we are working with aws to resolve it</p><h2 id=express-body-parser-middleware>express body-parser middleware</h2><p>To identify the requests that took a long time to process we added logs to our global express error handling middleware:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ts data-lang=ts><span style=display:flex><span>  <span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>err</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>req</span>: <span style=color:#66d9ef>express.Request</span>, <span style=color:#a6e22e>res</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>next</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>increment</span>({ <span style=color:#a6e22e>component</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;acidController&#39;</span>, <span style=color:#a6e22e>metric</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`uncaught_server_error`</span> });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>msgId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>v4</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>serializedError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>_</span>.<span style=color:#a6e22e>omit</span>(<span style=color:#e6db74>&#39;body&#39;</span>)(<span style=color:#a6e22e>serializeError</span>(<span style=color:#a6e22e>err</span>));
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`uncaught server error msgId: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msgId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. error: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>serializedError</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`uncaught server error msgId: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msgId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. query: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>query</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`uncaught server error msgId: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msgId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. method: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>method</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`uncaught server error msgId: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msgId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. headers: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>headers</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`uncaught server error msgId: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>msgId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>. body: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>logger</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;error in uncaught server error middleware&#39;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>status</span>(<span style=color:#ae81ff>500</span>).<span style=color:#a6e22e>json</span>({ <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;error&#39;</span> });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  });
</span></span></code></pre></div><p>We noticed that the requests that take a long time are requests that had a mismatch between their <code>content-length</code> header and the actual size of the parsed body object.
Here is an example log where we can see the issue:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;request aborted&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;code&#34;</span>: <span style=color:#e6db74>&#34;ECONNABORTED&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;expected&#34;</span>: <span style=color:#ae81ff>13548</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;length&#34;</span>: <span style=color:#ae81ff>13548</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;received&#34;</span>: <span style=color:#ae81ff>2048</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;request.aborted&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;BadRequestError&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;stack&#34;</span>: <span style=color:#e6db74>&#34;BadRequestError: request aborted\n    at IncomingMessage.onAborted (/app/node_modules/raw-body/index.js:231:10)\n    at IncomingMessage.emit (node:events:513:28)\n    at IncomingMessage.emit (node:domain:489:12)\n    at IncomingMessage._destroy (node:_http_incoming:224:10)\n    at _destroy (node:internal/streams/destroy:102:25)\n    at IncomingMessage.destroy (node:internal/streams/destroy:64:5)\n    at abortIncoming (node:_http_server:642:9)\n    at socketOnClose (node:_http_server:636:3)\n    at Socket.emit (node:events:525:35)\n    at Socket.emit (node:domain:489:12)\n    at TCP.&lt;anonymous&gt; (node:net:301:12)&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After doing some research we found a github issue in express-json middleware that talks about the exact same thing:
<a href=https://github.com/expressjs/body-parser/issues/329>https://github.com/expressjs/body-parser/issues/329</a></p><p>We also found a similar issue in nodejs repo itself:
<a href=https://github.com/nodejs/node/issues/17978>https://github.com/nodejs/node/issues/17978</a></p><p>The reason was explained by one of the comments in the nodejs issue:
<a href=https://github.com/nodejs/node/issues/17978#issuecomment-355283416>https://github.com/nodejs/node/issues/17978#issuecomment-355283416</a></p><blockquote><p>This is pretty much a fundamental thing about HTTP/1.1, I‚Äôd say. One of the primary purposes of the Content-Length headers is so that the other side can tell when the body is finished.
So if the request size as transmitted in the Content-Length header is too large, the server doesn‚Äôt really know when the ‚Äúreal‚Äù request body is finished if it doesn‚Äôt match that length.
Which would be the behavior you are expecting?</p></blockquote><blockquote><blockquote><p>A running service receives content-length while the client did not send a payload we wish to catch this case and send a correct HTTP response code which currently seems impossible. Any suggestions?
I‚Äôm not sure there‚Äôs much you can do besides relying on the timeout, or setting a shorter timeout. In what way is this causing trouble for you?</p></blockquote></blockquote><p>So, what happens? The content-length header of the request is larger than the actual body, so the middleware keeps waiting for newer chunks to arrive. Those new chunks will never arrive so the
middleware never finishes its job and the request hangs until the load balancer cancels it.
example code snippet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>http</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;http&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>createServer</span>((<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>chunks</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;data&#39;</span>, (<span style=color:#a6e22e>c</span>) =&gt; <span style=color:#a6e22e>chunks</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>c</span>));
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;end&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>500</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#ae81ff>3000</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>setTimeout</span>(<span style=color:#ae81ff>200</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>once</span>(<span style=color:#e6db74>&#39;SIGINT&#39;</span>, () =&gt; <span style=color:#a6e22e>server</span>.<span style=color:#a6e22e>close</span>());
</span></span></code></pre></div><p>The only way to fix this issue is to add a sane timeout to the server itself. üòû</p><p>Adding a timeout to the express server will be the subject of a different blog post üòé</p><ul class=pa0></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://zigius.github.io/>&copy; zlog - the zigius blog 2022</a><div><div class=ananke-socials></div></div></div></footer></body></html>